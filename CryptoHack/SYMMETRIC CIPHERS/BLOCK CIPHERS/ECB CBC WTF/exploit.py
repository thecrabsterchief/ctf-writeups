import requests
from pwn import xor


# encrypt mode CBC
def encrypt_flag():
    target = "https://aes.cryptohack.org/ecbcbcwtf/encrypt_flag/"
    res = requests.get(url=target).json()["ciphertext"]
    res = bytes.fromhex(res)
    iv, ct = res[:16], res[16:]
    return iv, ct

# decrypt mode ECB
def decrypt_ecb(ciphertext: bytes):
    target = "https://aes.cryptohack.org/ecbcbcwtf/decrypt/"
    res = requests.get(url="{}{}/".format(target, ciphertext.hex())).json()["plaintext"]
    return bytes.fromhex(res)

# decrypt mode CBC
def decrypt_cbc(ciphertext: bytes, iv: bytes):
    blocks = [ciphertext[i:i+16] for i in range(0, len(ciphertext), 16)]
    plaintext = b""

    previous_block = iv
    for block in blocks:
        plaintext += xor(previous_block, decrypt_ecb(block))
        previous_block = block
    
    return plaintext

if __name__ == "__main__":
    iv, enc_flag = encrypt_flag()
    flag = decrypt_cbc(enc_flag, iv)
    print(flag)